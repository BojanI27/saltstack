# /usr/lib/nagios/plugins/check_wmi_plus.pl -H WinPC -A /etc/check_wmi_plus/hypervauth.txt -m checktime -w 10
# 

template Service "wmi-service-hv" {
  import "generic-service"
  check_command =  "check_wmi"
  check_interval = 3m
  retry_interval = 15m
  max_check_attempts = 3
  event_command = "autoack"
  vars.wmi_authfile_path = "/etc/check_wmi_plus/hypervauth.txt"
# Create this file (copy domainauth.txt) and enter local administrator credentials
# DOMAIN field should exist, value is irelevant
# Use IP addreses as object name as hostnames can not be found in AD DNS
# add registry keys / change permissions 
# serverfault.com/questions/607102/what-is-the-workaround-for-wmi-remote-connection-failure-with-access-denied-erro
}


apply Service "UP Time" {
  import "wmi-service-hv"
  check_interval = 5m
  retry_interval = 5m

  vars.check_mode = "checkuptime"
  vars.wmi_nodatamode = true
  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
}

apply Service "Clock" {
  import "wmi-service-hv"
  check_interval = 60m
  retry_interval = 60m
  vars.wmi_warn = "100"
  vars.wmi_crit = "1800"
  vars.check_mode = "checktime"

  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
}


apply Service "Disk" {
  import "wmi-service-hv"
  check_interval = 10m
  retry_interval = 10m
  vars.check_mode = "checkdrivesize"
  vars.wmi_arg1 = "."
  vars.wmi_warn = "95"
  vars.wmi_crit = "98"

  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
}

apply Service "Memory" {
  import "wmi-service-hv"
  check_interval = 10m
  retry_interval = 10m
  vars.check_mode = "checkmem"
  vars.wmi_warn = "80"
  vars.wmi_crit = "90"

  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
}

apply Service "CPU" {
  import "wmi-service-hv"
  check_interval = 5m
  retry_interval = 10m
  vars.check_mode = "checkeachcpu"
  vars.wmi_warn = "80"
  vars.wmi_crit = "90"

  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
}

apply Service "CPU Hungry Apps" {
  import "wmi-service-hv"
  check_interval = 5m
  retry_interval = 10m
  vars.check_mode = "checkproc"
  vars.wmi_submode = "cpuabove"
  vars.wmi_arg1 = "%"
  vars.wmi_exclude = "_AvgCPU=@0:10"
  vars.wmi_delay = "0"
  vars.wmi_warn = "80"
  vars.wmi_crit = "90"
  vars.wmi_nodatamode = true

  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
}

apply Service "Swap" {
  import "wmi-service-hv"

  vars.check_mode = "checkpage"
  vars.wmi_arg1 = "auto"

  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
}


apply Service "Network Cards" {
  import "wmi-service-hv"

  vars.check_mode = "checknetwork"
#  vars.wmi_arg1 = "192."
  vars.wmi_arg1 = "."
  vars.wmi_warn = "_SendBytesUtilisation=20"
  vars.wmi_crit = "_SendBytesUtilisation=40"

  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
}

apply Service "Log: System" {
  import "wmi-service-hv"

  vars.check_mode = "checkeventlog"
  vars.wmi_arg1 = "system"
  vars.wmi_arg2 = "2"
  vars.wmi_arg3 = "1"
  vars.wmi_warn = "50"
  vars.wmi_crit = "100"

  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
}

apply Service "Log: Application" {
  import "wmi-service-hv"

  vars.check_mode = "checkeventlog"
  vars.wmi_arg1 = "application"
  vars.wmi_arg2 = "2"
  vars.wmi_arg3 = "1"
  vars.wmi_warn = "50"
  vars.wmi_crit = "100"

  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
}

apply Service "Services" {
  import "wmi-service-hv"

  vars.check_mode = "checkservice"
  vars.wmi_arg1 = "auto"
  vars.wmi_warn = "3"
  vars.wmi_crit = "5"

  assign where host.vars.os == "WindowsHV"
  ignore where host.vars.disable_wmi
  ignore where host.vars.windesktop == "True"

}

apply Service "Vipre Process" {
  import "wmi-service-hv"

  vars.check_mode = "checkproc"
  vars.wmi_submode = "count"
  vars.wmi_arg1 = "sbamsvc"
  vars.wmi_warn = "1:1"
  vars.wmi_nodatamode = "32134234"

  assign where host.vars.os == "WindowsHVX"
  ignore where host.vars.disable_wmi

}

apply Service "Info: OS Version" {
  import "wmi-service-hv"
  vars.check_mode = "info"
  vars.wmi_submode = "os"
  check_interval = 100m
  retry_interval = 30m

  assign where host.vars.os == "WindowsHVX"
  ignore where host.vars.disable_wmi
}

apply Service "Info: Network Adapters" {
  import "wmi-service-hv"
  check_interval = 10m
  retry_interval = 30m
  vars.check_mode = "info"
  vars.wmi_submode = "net"

  assign where host.vars.os == "WindowsHVX"
  ignore where host.vars.disable_wmi
}

apply Service "Info: CPU details" {
  import "wmi-service-hv"
  check_interval = 100m
  retry_interval = 30m

  vars.check_mode = "info"
  vars.wmi_submode = "cpu"

  assign where host.vars.os == "WindowsHVX"
  ignore where host.vars.disable_wmi
}

apply Service "Users" {
  import "wmi-service-hv"

  vars.check_mode = "checkts"
  vars.wmi_submode = "sessions"
  vars.wmi_warn = "ActiveSessions=1 -w TotalSessions=2"
  vars.wmi_crit = "ActiveSessions=2 -c TotalSessions=2"

  assign where host.vars.os == "WindowsHVX"
  ignore where host.vars.disable_wmi
}

apply Service "Disk IO C:" {
  import "wmi-service-hv"

  vars.check_mode = "checkio"
  vars.wmi_submode = "logical"
  vars.wmi_arg1 = "C:"

  assign where host.vars.os == "WindowsHVX"
  ignore where host.vars.disable_wmi
}
